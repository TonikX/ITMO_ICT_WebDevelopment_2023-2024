# Практическая часть
Цель: получить представление о работе с запросами в Django ORM.
 
<a href="https://docs.google.com/document/d/1jB8EYOWk-bbjB6sLr1s7dOmLYRC9Z5jIV6xIpnigdvY/edit?usp=sharing" class="external-link" target="_blank">Текст работы</a>


=== "Модели"

    ```Python
    --8<-- "../../practical_works/Novikov_Alexey/simple_drf_project/project_first_app/models.py"
    ```

=== "Задание 1"

    ???+ question "Задание 1"
    
        Напишите запрос на создание 6-7 новых автовладельцев и 5-6 автомобилей, 
        каждому автовладельцу назначьте удостоверение и от 1 до 3 автомобилей. 
        
        Задание можете выполнить либо в интерактивном режиме интерпретатора, либо в отдельном python-файле. 
        
        Результатом должны стать запросы и отображение созданных объектов. 
 
    ```Python
    --8<-- "../../practical_works/Novikov_Alexey/simple_drf_project/create_data.py"
    ```

    Укажем файл настроек проекта в виртуальном окружении и запустим `django.setup()`, чтобы сконфигурировать настройки 
    и иметь возможность запускать этот файл независимо.

    Только после этого мы можем импортировать и использовать модели.

    С помощью метода `bulk_create` создадим сразу несколько объектов одним запросом.

    Создадим таким образом 6 автовладельцев и 6 машин. Затем так же с помощью `bulk_create` создадим 6 автовладений 
    и 6 лицензий. Список объектов будем создавать с помощью list comprehension.

    Затем выведем все полученные объекты и получим следующее:

    <figure markdown>
      ![Задание 1](http://localhost:8000/img/pw3/task1.png)
    </figure>

=== "Задание 2"

    ???+ question "Задание 2"
    
        По созданным в задании 1 данным написать следующие запросы на фильтрацию:

        * Где это необходимо, добавьте related_name к полям модели;
        * Выведете все машины марки “Toyota” (или любой другой марки, которая у вас есть);
        * Найти всех водителей с именем “Олег” (или любым другим именем на ваше усмотрение);
        * Взяв любого случайного владельца получить его id, и по этому id получить экземпляр 
        удостоверения в виде объекта модели (можно в 2 запроса);
        * Вывести всех владельцев красных машин (или любого другого цвета, который у вас присутствует);
        * Найти всех владельцев, чей год владения машиной начинается с 2010 (или любой другой год, 
        который присутствует у вас в базе).

    ```Python
    --8<-- "../../practical_works/Novikov_Alexey/simple_drf_project/filter_data.py"
    ```

    Укажем файл настроек проекта в виртуальном окружении и запустим `django.setup()`, чтобы сконфигурировать настройки 
    и иметь возможность запускать этот файл независимо.

    Только после этого мы можем импортировать и использовать модели.

    Машины марки Toyota и водителей с именем Иван получим, используя базовый фильтр по значению поля.

    Случайного автовладельца получим, используя аргумент `"?"` в методе `order_by`. Затем с помощью `values_list("id", flat=True)` 
    получим список значений "id", а не список объектов/словарей.  
    Используя метод `first` получим только первого значение в этом списке.

    Полученное значение затем используем в фильтре для водительских удостоверений.

    Список автовладельцев чёрного цвета получим, используя фильтр по внешним ключам (через разделитель `__`) в модели 
    `CarOwner`. Сначала перейдём по ключу `ownership` к автовладениям, от него по ключу `car` перейдём к автомобилям и здесь 
    уже используем фильтр по цвету.

    Схожим образом получим автовладельцев, получивших лицензию в этом году.

    Затем выведем все полученные объекты и получим следующее:

    <figure markdown>
      ![Задание 2](http://localhost:8000/img/pw3/task2.png)
    </figure>

=== "Задание 3"

    ???+ question "Задание 3"
    
        Необходимо реализовать следующие запросы c применением описанных методов:

        * Вывод даты выдачи самого старшего водительского удостоверения;
        * Укажите самую позднюю дату владения машиной, имеющую какую-то из существующих моделей в вашей базе;
        * Выведите количество машин для каждого водителя;
        * Подсчитайте количество машин каждой марки;
        * Отсортируйте всех автовладельцев по дате выдачи удостоверения. 

    ```Python
    --8<-- "../../practical_works/Novikov_Alexey/simple_drf_project/aggregate_annotate_data.py"
    ```

    Укажем файл настроек проекта в виртуальном окружении и запустим `django.setup()`, чтобы сконфигурировать настройки 
    и иметь возможность запускать этот файл независимо.

    Только после этого мы можем импортировать и использовать модели.

    Самое старшее водительское удостоверение получим с помощью метода `aggregate` и функции `Min`, которую используем для 
    поля даты выдачи.

    Самую позднюю дату владения машиной получим аналогичным образом, но используя функцию `Max` по дате начала владения.

    Чтобы вывести количество машин для каждого владельца, сначала создадим новое поле `count` с помощью метода 
    `annotate` и функции `Count`, а затем проитерируемся по полученнуму запросу и возьмём от каждого объекта фамилию, имя 
    и количество машин.

    Количество машин каждой марки подсчитаем схожим образом, но перед применением метода `annotate` сначала вызовем 
    метод `values`, с помощью которого получим марки машин.

    Отсортируем всех владельцев по дате выдачи удостоверения, используя метод `order_by` и поле `start_date`, 
    к которому обратимся через внешний ключ `ownerships` в модели автовладельцев.

    Затем выведем все полученные объекты и получим следующее:

    <figure markdown>
      ![Задание 3](http://localhost:8000/img/pw3/task3.png)
    </figure>