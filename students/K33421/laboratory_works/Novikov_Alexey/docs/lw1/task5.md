# Задание №5

???+ question "Задание"

    Необходимо написать простой web-сервер для обработки GET и POST http
    запросов средствами Python и библиотеки socket.

    Базовый класс для простейшей реализации web-сервера доступен по 
    <a href="https://docs.google.com/document/d/1lv_3D9VtMxz8tNkA6rA1xu9zaWEIBGXiLWBo1cse-0k/edit?usp=sharing" 
    class="external-link" target="_blank">ссылке</a>.

    Задание: сделать сервер, который может:

    - Принять и записать информацию о дисциплине и оценке по дисциплине.
    - Отдать информацию обо всех оценах по дсициплине в виде html-страницы.

=== "Сервер"

    ```Python title="server.py"
    --8<-- "laboratory_work_1/task5/server.py"
    ```
    
    Немного отошёл от структуры базового класса: отказался от переменной `name`, потому что не нашёл для неё применений, 
    добавил метод `parse_body` для парсинга тела запроса, а также разделил метод `handle_request` на 2: отдельно для GET 
    и POST запросов.

    В переменной класса инициализируем два объекта: `data` для хранения списка оценок и `Grade`, namedtuple для хранения 
    информации о каждой оценке.

    В `__init__` создаём 2 атрибута: хост и порт сокета сервера.

    В методе `serve_forever` на этот раз с помощью контекстного менеджера создаём и настраиваем сокет сервера и запускаем 
    цикл `#!py3 while`, который принимает подключения клиентов. Сокет клиента так же с помощью контекстного менеджера 
    отправляется в метод `serve_client`.

    Метод `serve_client` принимает запрос пользователя. Проверяет, является ли он пустым. Если нет - парсит его HTTP метод, 
    путь и версию HTTP c помощью метода `parse_request` и парсит его заголовки с помощью метода `parse_headers`. 
    Затем, проверяя метод, либо отправляет путь запроса и сокет клиента в метод `handle_get_request`, либо дополнительно 
    с помощью метода `parse_body` парсит тело запроса и отправляет путь, тело и сокет в метод `handle_post_request`.

    Метод `handle_get_request` проверяет путь запроса, если он совпадает с нужным (в моём случае со стартовой страницей), 
    получает содержимое файла `index.html`, объединяет все оценки из словаря `data`, заменяет оценками шаблон в HTML-файле 
    и отправляет полученное будущее тело запроса в метод `send_response`. Если путь не удовлетворил требованиям, 
    в метод `send_response` отправится содержимое файла `not_found.html` вместе со статус кодом `404 Not Found`.

    Метод `handle_post_request` так же проверяет путь запроса и в случае совпадения проверит содержимое тела запроса, 
    получит оттуда название дисциплины и оценку и добавит эту информацию в словарь `data`. Затем передаст пустое тело запроса 
    в метод `send_response`. Если путь не удовлетворил требованиям, то так же отправляет содержимое файла `not_found.html`. 

    В методе `send_response` создаётся словарь заголовков, "трансформируется" в строку, затем объединяется с версией HTTP, 
    статус кодом и телом запроса и отправляется клиенту.
    

=== "HTML-файлы"

    ```HTML title="index.html"
    --8<-- "laboratory_work_1/task5/index.html"
    ```

    ```HTML title="not_found.html"
    --8<-- "laboratory_work_1/task5/not_found.html"
    ```

    В файле `index.html` создаём базовую форму с 2 полями для ввода (дисциплина и оценка) и кнопкой отправить.

    На 2 поле настроена валидация, реагирующая на ивент onchange и проверяющая, что введённое значение находится 
    в допустимых пределах.

    При нажатии на кнопку Отправить вызывается функция, которая собирает значения этих 2 полей, объединяет их в JSON 
    и отправляет POST-запросом на сервер, затем обновляет страницу.

    <figure markdown>
      ![Отображение в браузере](https://kinsl.github.io/ITMO_ICT_WebDevelopment/img/lw1/task5/client.png)
      <figcaption>Отображение в браузере</figcaption>
    </figure>